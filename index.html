<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover" />
<title>Cat Farm (Coins + Battle Pets + Boss)</title>

<link rel="stylesheet" href="styles.css">
<link rel="stylesheet" href="auth.css">

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<!-- Mobile scaling: keeps the 552Ã—911 canvas pixel-perfect on any phone -->
<script>
(function(){
  var DESIGN_W = 552;
  var DESIGN_H = 911;

  function applyScale(){
    var vw = window.innerWidth;
    var vh = window.innerHeight;
    var isLandscape = vw > vh;
    var scale, originX, originY;

    if(isLandscape && vw < 1024){
      // Landscape mobile: fit height
      scale = Math.min(vh / DESIGN_H, vw / DESIGN_W);
      originX = 0; originY = 0;
    } else if(vw < DESIGN_W){
      // Portrait mobile: fit width
      scale = vw / DESIGN_W;
      originX = 0; originY = 0;
    } else {
      // Desktop / tablet: no scaling needed
      scale = 1;
      originX = null; originY = null;
    }

    ['menu','game'].forEach(function(id){
      var el = document.getElementById(id);
      if(!el) return;
      if(scale !== 1){
        el.style.transform = 'scale(' + scale + ')';
        el.style.transformOrigin = (originX !== null ? originX+'px '+originY+'px' : 'top center');
      } else {
        el.style.transform = '';
        el.style.transformOrigin = '';
      }
    });

    // Shrink body to match scaled canvas so page doesn't scroll
    if(scale !== 1){
      document.body.style.height = Math.ceil(DESIGN_H * scale) + 'px';
      document.body.style.overflow = 'hidden';
    } else {
      document.body.style.height = '';
      document.body.style.overflow = '';
    }
  }

  // Run on load and whenever the viewport changes
  window.addEventListener('resize', applyScale);
  window.addEventListener('orientationchange', function(){
    setTimeout(applyScale, 120); // slight delay for orientation to settle
  });

  // Run immediately (DOM is partially parsed at this point) and after load
  applyScale();
  window.addEventListener('DOMContentLoaded', applyScale);
})();
</script>

</head>

<body>

<!-- LOADING SCREEN -->
<div id="loadingScreen">
  <div class="loadingContent">
    <div class="loadingLogo">
      <img src="images/title.png" alt="Cat Farm" class="loadingTitle" onerror="this.style.display='none'">
    </div>
    <div class="loadingBarOuter">
      <div class="loadingBarInner" id="loadingBarInner"></div>
    </div>
    <div class="loadingTip" id="loadingTip">Growing cropsâ€¦</div>
    <div class="loadingPaws">ğŸ¾</div>
  </div>
</div>

<!-- AUTH SCREEN -->
<div id="authScreen" style="display:none;">
  <div class="authBg">
    <div class="authCloud authCloud1"></div>
    <div class="authCloud authCloud2"></div>
    <div class="authCloud authCloud3"></div>
    <div class="authFlower authFlower1">ğŸŒ¸</div>
    <div class="authFlower authFlower2">ğŸŒ»</div>
    <div class="authFlower authFlower3">ğŸ€</div>
  </div>

  <div class="authCard">
    <div class="authLogoArea">
      <img src="images/title.png" alt="Cat Farm" class="authTitleImg" onerror="this.style.display='none'">
      <p class="authTagline">Farm, Learn &amp; Catch Pets! ğŸ¾</p>
    </div>

    <!-- Tab switcher -->
    <div class="authTabs">
      <button class="authTab active" id="tabLogin" onclick="switchAuthTab('login')">Log In</button>
      <button class="authTab" id="tabSignup" onclick="switchAuthTab('signup')">Sign Up</button>
    </div>

    <div class="authForm">
      <div class="authInputGroup">
        <span class="authInputIcon">âœ‰ï¸</span>
        <input id="authEmail" type="email" placeholder="Email address" autocomplete="email">
      </div>
      <div class="authInputGroup">
        <span class="authInputIcon">ğŸ”’</span>
        <input id="authPassword" type="password" placeholder="Password" autocomplete="current-password">
      </div>

      <button class="authSubmitBtn" id="btnLogin" onclick="void(0)">Log In</button>
      <button class="authSubmitBtn authSubmitSecondary" id="btnSignup" onclick="void(0)" style="display:none;">Create Account</button>

      <div class="authDivider"><span>or</span></div>
      <button class="authGuestBtn" onclick="guestPlay()">â–¶ Play as Guest</button>
    </div>

    <div id="authStatus" class="authStatus"></div>

    <!-- Hidden logout (used by supabase.js) -->
    <button id="btnLogout" style="display:none;"></button>
    <!-- Hidden close (used by supabase.js) -->
    <button id="authClose" style="display:none;"></button>
    <!-- Hidden openAuth (used by supabase.js) -->
    <button id="openAuth" style="display:none;"></button>
  </div>

  <div class="authFooter">
    <span>ğŸŒ¾ Your progress syncs across devices when logged in</span>
  </div>
</div>

<!-- MAIN MENU -->
<div id="menu">
  <div class="menuCard">
    <img src="images/title.png" alt="title" class="menuTitle">

    <button onclick="startGame()"><span>Play</span></button>
    <div class="buttonGroup2">
      <button onclick="openInfo()" class="button2"><span>What's New</span></button>
      <button onclick="openLeaderboard()" class="button2"><span>Leaderboard</span></button>
    </div>
  </div>
</div>

<!-- GAME -->
<div id="game">
  <div id="toast"><span>âš ï¸</span><span id="toastText">A wild pet has appeared!</span></div>

  <div class="header">
    <div class="profileArea">
      <div class="dpandlevelcon">
        <div class="profilecon" id="profileBtn" onclick="openProfile()" onerror="this.style.display='none'">
        <img src="images/profile.png" alt="profile"/>
      </div>
      <div id="LevelTxtCon"><h3 id="LevelTxt"></h3></div>
      </div>
      <div class="nameStack">
        <div id="playerNameDisplay">Player</div>
        <div id="playerTitleDisplay">Rookie Farmer</div>
          <div id="xpBarContainer">
          <div id="xpBar"></div>
          <div id="xpLevelText">Lvl 1</div>
        </div>
        
      </div>
    </div>

    <div class="coinCon">
      <div class="coinbox" id="coinBox">
        <img src="images/coin.png" alt="coin" onerror="this.style.display='none'"/>
        <span id="coins">0</span>
      </div>

      <div class="coinbox" id="petBox" title="Captured pets">
        <span style="font-size:18px;">ğŸ¾</span>
        <span id="petCount">0</span>
      </div>

      <button id="logoutBtn" class="logoutBtn" onclick="handleLogout()" title="Log out" style="display:none;">ğŸšª</button>
      <button id="cloudSaveBtn" class="cloudSaveBtn" onclick="openAuthScreen()" title="Sign in to Cloud Save">â˜ï¸</button>
    </div>
    
  </div>

  <!-- FARM SCREEN -->
  <div id="farmScreen" class="screen">
     
    <div class="farmcon">

      <div class="townZooCon" >
        <button onclick="openZoo()" class="toZooBtn"><span data-title="Ranch">Ranch</span></button>
        <button onclick="showTown()" class="toTownBtn"><span data-title="Town">Town</span></button>
      </div>

      <div class="toolStrip" id="toolStrip">
        <!-- Arrow indicator -->
        <div id="toolsArrow"><img src="images/toolArrow.png" alt="toolArrow"></div>
        <!-- Expanding list of tools -->
        <div id="toolsPanel">
          <button class="toolBtn" id="toolHarvestBtn" onclick="setTool('harvest')"><img src="images/harvesttool.png" alt="Harvest"><span data-title="Harvest">Harvest</span></button>
          <button class="toolBtn active" id="toolPlantBtn"  onclick="setTool('plant')"><img src="images/planttool.png" alt="Plant"><span data-title="Plant">Plant</span></button>
          <button class="toolBtn" id="toolMoveBtn" onclick="setTool('move')"><img src="images/movetool.png" alt="Move"><span data-title="Move">Move</span></button>
          <button class="toolBtn"  id="toolRemoveBtn" onclick="setTool('remove')"><img src="images/removetool.png" alt="Remove"><span data-title="Remove">Remove</span></button>
        </div>
        <!-- Main Button -->
        <button class="toolBtn" id="toolsToggleBtn" type="button"> <img id="currentToolIcon" src="images/harvesttool.png" alt="Current Tool"><span data-title="Tool">Tool</span></button>
      </div>
      <img src="images/fence.png" alt="fence1" class="fence1" onerror="this.style.display='none'"/>
      <div id="farmWrap">
        <div id="eventLayer"></div>
        <div id="farm"></div>
      </div>
      <img src="images/fence.png" alt="fence2" class="fence2" onerror="this.style.display='none'"/>
    </div>
  </div>

 

  <!-- TOWN SCREEN -->
  <div id="townScreen" class="screen">
    <!-- Spacer to push townGrid below the shared header -->
    <div class="townHeaderSpacer"></div>

    <div class="townGrid">
      <button class="towntoRanchBtn" id="townToggleBtn2" onclick="openZoo()" title="Town / Farm"> <span id="townBtnIcon" data-title="Ranch">Ranch</span></button>
      <div class="building" id="buildingArena" onclick="openArena()">
        <div class="name" data-title="Arena">Arena</div>
        <div class="tag">Battle (PvP)</div>
      </div>

      <div class="building" id="buildingMarket" onclick="openSupermarket()">
        <div class="name" data-title="Supermarket">Supermarket</div>
        <div class="tag">Boosts + Limited Seeds</div>
      </div>

      <div class="building" id="buildingLibrary" onclick="openLibrary()">
        <div class="name" data-title="Library">Library</div>
        <div class="tag">Library exam (daily)</div>
      </div>
      
      <div class="building" id="buildingQuestBoard" onclick="openQuestBoard()">
        <div class="name" data-title="Quest Board">Quest Board</div>
        <div class="tag">Daily quests + streak</div>
      </div>

      <button class="towntoFarmBtn" id="townToggleBtn" onclick="toggleTown()" title="Town / Farm"> <span id="townBtnIcon" data-title="Farm">Farm</span></button>

    </div>
    <div class="townHint">Wild pets enter from the side. Clean poop for rewards!</div>
  </div>

  <!-- ZOO SCREEN -->
  <div id="zooScreen" class="screen">
    <!-- <div class="zooTitle">Zoo</div>
    <div class="zooSub">Your captured pets can roam freely here.</div> -->
    
    <div id="zooYard" title="Tap a pet to view details">

      <div class="townZooCon2" >
        <button onclick="toggleTown()" class="toFarmBtn2"><span data-title="Farm">Farm</span></button>
        <button onclick="showTown()" class="toTownBtn2"><span data-title="Town">Town</span></button>
      </div>

      <img src="images/fence.png" alt="fence1" class="fence1" onerror="this.style.display='none'"/>

        <div id="zooRoamLayer"></div>
        <div id="zooEmpty" class="zooEmpty"><span>No pets yet. Capture wild pets on your farm!</span></div>

      <img src="images/fence.png" alt="fence2" class="fence2" onerror="this.style.display='none'"/>
    </div>
    

    <div id="zooStats" class="zooStats">Pets: <b>0</b></div>
    <div class="zooHint" data-title="Tip: Open Town ğŸ˜ï¸ to visit the Library and Quest Board.">Tip: Open Town ğŸ˜ï¸ to visit the Library and Quest Board.</div>

    <div class="zooNav">
      <button class="bottomBtn" id="btnCrops" onclick="openArena()">
        <img src="images/crops.png" alt="crops" onerror="this.style.display='none'"><span data-title="Arena">Arena</span>
      </button>
    </div>
    
  </div>

  <!-- ARENA BATTLE SCREEN -->
  <div id="arenaScreen" class="screen">

    <!-- TOP HALF: battle field -->
    <div id="arenaBattleField">

      <!-- Player side (bottom-left) -->
      <div id="arenaPlayerSide" class="arenaSide arenaPlayerSide">
        <div class="arenaAnimalName" id="arenaP1Name"></div>
        <div class="arenaHpBar">
          <div class="arenaHpFill" id="arenaP1HpFill"></div>
        </div>
        <div class="arenaHpLabel" id="arenaP1HpLabel"></div>
        <div class="arenaAnimalSprite" id="arenaP1Sprite"></div>
        <div class="arenaStatusRow" id="arenaP1Status"></div>
        <!-- Platform: swap src to use your own asset -->
        <div class="arenaPlatform" id="arenaP1Platform"></div>
      </div>

      <!-- Enemy side (top-right) -->
      <div id="arenaEnemySide" class="arenaSide arenaEnemySide">
        <div class="arenaAnimalName" id="arenaP2Name"></div>
        <div class="arenaHpBar">
          <div class="arenaHpFill" id="arenaP2HpFill"></div>
        </div>
        <div class="arenaHpLabel" id="arenaP2HpLabel"></div>
        <div class="arenaAnimalSprite" id="arenaP2Sprite"></div>
        <div class="arenaStatusRow" id="arenaP2Status"></div>
        <!-- Platform: swap src to use your own asset -->
        <div class="arenaPlatform" id="arenaP2Platform"></div>
      </div>

      <!-- Battle log ribbon -->
      <div id="arenaBattleLog"></div>

    </div>

    <!-- BOTTOM HALF: action panel -->
    <div id="arenaActionPanel">

      <!-- Default skill buttons -->
      <div id="arenaSkillButtons">
        <div class="arenaRoundLabel" id="arenaRoundLabel">Round 1</div>
        <div class="arenaSkillRow">
          <button class="arenaSkillBtn arenaSkillNormal" id="btnArenaAttack" onclick="arenaScreenUseSkill('attack')">
            <span class="arenaBtnTitle">Normal</span>
            <span class="arenaBtnSub" id="arenaAttackSkillName"></span>
          </button>
          <button class="arenaSkillBtn arenaSkillHeavy" id="btnArenaHeavy" onclick="arenaScreenUseSkill('heavy')">
            <span class="arenaBtnTitle">Heavy</span>
            <span class="arenaBtnSub" id="arenaHeavySkillName"></span>
          </button>

        </div>
        <button class="arenaExitBtn" onclick="exitArenaScreen()">âœ• Forfeit</button>
      </div>

      <!-- Word-connect challenge (shown when skill is pressed) -->
      <div id="arenaWordChallenge" style="display:none;">
        <div class="arenaWordPrompt">Connect the letters to spell:</div>
        <div class="arenaWordTarget" id="arenaWordTarget"></div>
        <div class="arenaWordCanvas">
          <canvas id="arenaWordBgCanvas"></canvas>
          <canvas id="arenaWordCanvas"></canvas>
        </div>
        <div class="arenaWordProgress" id="arenaWordProgress"></div>
        <button class="arenaWordResetBtn" onclick="arenaWordReset()">â†º Reset</button>
      </div>

    </div>

    <!-- Loading overlay (shown while "loading") -->
    <div id="arenaLoadingOverlay">
      <div class="arenaLoadingBox">
        <div class="arenaLoadingIcon">âš”ï¸</div>
        <div class="arenaLoadingTitle">Preparing Battleâ€¦</div>
        <div class="arenaLoadingBarWrap"><div class="arenaLoadingBarFill" id="arenaLoadingBarFill"></div></div>
        <div class="arenaLoadingHint" id="arenaLoadingHint">Loading assetsâ€¦</div>
      </div>
    </div>

  </div>

  <!-- Bottom nav -->
  <div class="bottomNav">
    <div id="bottomBar">
      <button class="bottomBtn" id="btnCrops" onclick="openCrops()">
        <img src="images/crops.png" alt="crops" onerror="this.style.display='none'"><span data-title="Crops">Crops</span>
      </button>
      <button class="bottomBtn" onclick="openHarvestShop()">
        <img src="images/shop.png" alt="market"> <span data-title="Market">Market</span>
      </button>
      <button class="bottomBtn" onclick="openInventory()">
        <img src="images/inventory.png" alt="bag"> <span data-title="Inventory">Inventory</span>
      </button>
      <button class="bottomBtn" id="btnZoo" onclick="openZoo()">
        <img src="images/zoo.png" alt="zoo" onerror="this.style.display='none'"> <span data-title="Ranch">Ranch</span>
      </button>
    </div>
  </div>
</div>

<!-- TUTORIAL OVERLAY (Spotlight + Arrow) -->
<div id="tutorialOverlay" title="Click anywhere to continue â€¢ Double-click to skip">
  <div class="tutorialBlocker"></div>
  <div id="tutorialHighlight"></div>
  <svg id="tutorialArrowSvg" viewBox="0 0 100 100" preserveAspectRatio="none"></svg>
  <div id="tutorialBubble">
    <div id="tutorialMascot">ğŸ±</div>
    <div id="tutorialRight">
      <div id="tutorialTitle">Mao the Cat</div>
      <div id="tutorialText"></div>
      <div id="tutorialHint">Click anywhere to continue â€¢ Double-click anywhere to skip</div>
    </div>
  </div>
</div>

<!-- MODAL -->
<div id="modal" class="modal">
  <div class="modalBox">
    <div class="modalHeader">
      <div id="modalTitleCon"><h2 id="modalTitle"></h2></div>
      <button class="modalClose" onclick="closeModal()"></button>
    </div>
    <div id="modalContent"></div>
  </div>
</div>

<!-- 1. Utilities & Config (no dependencies) -->
<script src="js/utils.js"></script>
<script src="js/gameBalance.js"></script>
<script src="js/quizBank.js"></script>

<!-- 2. Data / State -->
<script src="js/arenaData.js"></script>
<script src="js/petsData.js"></script>
<script src="js/boosts.js"></script>

<!-- 3. Core Systems -->
<script src="js/saveLoad.js"></script>
<script src="js/xpLevel.js"></script>
<script src="js/questionRenderer.js"></script>

<!-- 4. UI & Navigation -->
<script src="js/ui.js"></script>
<script src="js/tutorial.js"></script>
<script src="js/uiUpdate.js"></script>

<!-- 5. Game Screens -->
<script src="js/farmGrid.js"></script>
<script src="js/plantingHarvesting.js"></script>
<script src="js/tools.js"></script>
<script src="js/zoo.js"></script>
<script src="js/arena.js"></script>
<script src="js/arenaScreen.js"></script>
<script src="js/bossFight.js"></script>

<!-- 6. Wild Pets -->
<script src="js/wildPetSpawn.js"></script>
<script src="js/wildPetEntity.js"></script>

<!-- 7. Quests, Shop, Library -->
<script src="js/dailyQuests.js"></script>
<script src="js/shopInventory.js"></script>
<script src="js/libraryExam.js"></script>

<!-- 8. World / Init -->
<script src="js/tileUnlock.js"></script>
<script src="js/gameLoop.js"></script>
<script src="js/startGame.js"></script>
<script src="js/initDefaults.js"></script>

<!-- 9. Auth â€” load last (depends on game being ready) -->
<script src="js/supabase.js"></script>


<!-- Auth + Loading screen logic -->
<script>
(function(){
  const tips = [
    "Watering cropsâ€¦ ğŸŒ±",
    "Feeding wild catsâ€¦ ğŸ±",
    "Sharpening harvest toolsâ€¦ ğŸ”¨",
    "Counting coinsâ€¦ ğŸª™",
    "Waking up petsâ€¦ ğŸ¾",
    "Preparing the farmâ€¦ ğŸŒ¾",
    "Loading quiz questionsâ€¦ ğŸ“š",
    "Building the townâ€¦ ğŸ˜ï¸",
  ];
  let tipIdx = 0;
  const bar  = document.getElementById("loadingBarInner");
  const tip  = document.getElementById("loadingTip");
  let progress = 0;
  let finished = false;

  const tipInterval = setInterval(() => {
    tipIdx = (tipIdx + 1) % tips.length;
    if (tip) tip.textContent = tips[tipIdx];
  }, 700);

  // Bar fills steadily to 85% on its own, then waits for finishLoading()
  const barInterval = setInterval(() => {
    progress = Math.min(progress + (Math.random() * 12 + 8), 85);
    if (bar) bar.style.width = progress + "%";
    if (progress >= 85) clearInterval(barInterval);
  }, 150);

  function doFinish() {
    if (finished) return;
    finished = true;
    clearInterval(tipInterval);
    clearInterval(barInterval);
    clearTimeout(fallbackTimer);
    if (bar) bar.style.width = "100%";
    setTimeout(() => {
      const ls = document.getElementById("loadingScreen");
      if (ls) {
        ls.classList.add("fade-out");
        setTimeout(() => { ls.style.display = "none"; }, 500);
      }
      // If a session token exists in localStorage, skip the auth screen
      // and go straight to the menu. The supabase client will restore
      // the session automatically when it initialises.
      const hasSession = Object.keys(localStorage).some(k => k.includes("supabase") && k.includes("auth"));
      if (hasSession) {
        const as = document.getElementById("authScreen");
        if (as) as.style.display = "none";
        const menu = document.getElementById("menu");
        if (menu) menu.style.display = "flex";
      } else {
        const as = document.getElementById("authScreen");
        if (as) as.style.display = "flex";
        const menu = document.getElementById("menu");
        if (menu) menu.style.display = "none";
      }
    }, 300);
  }

  window.finishLoading = doFinish;

  // Guest play: hide auth screen, show menu
  window.guestPlay = function() {
    const as = document.getElementById("authScreen");
    if (as) as.style.display = "none";
    const menu = document.getElementById("menu");
    if (menu) menu.style.display = "flex";
  };

  // Hard fallback: if finishLoading() is never called (e.g. a JS error
  // in another script stops initDefaults.js from finishing), force-dismiss
  // the loading screen after 5 seconds so the player isn't stuck.
  var fallbackTimer = setTimeout(() => {
    console.warn("finishLoading() not called â€” forcing loading screen dismiss");
    doFinish();
  }, 5000);

  // Keep menu and auth hidden until loading finishes
  document.addEventListener("DOMContentLoaded", () => {
    const menu = document.getElementById("menu");
    if (menu) menu.style.display = "none";
  });
})();
</script>
</body>
</html>